# ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Custom Claims System

## üéØ Custom Claims ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?

**Firebase Auth Custom Claims** ‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡∏¥‡∏° (metadata) ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Firebase Authentication token ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ query Firestore ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á

### ‡∏Ç‡πâ‡∏≠‡∏î‡∏µ:
- ‚ö° **‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤**: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á query Firestore ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ role
- üîí **‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢**: ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô JWT token (‡∏õ‡∏•‡∏≠‡∏°‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
- üõ°Ô∏è **Security Rules**: ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Firestore/Storage Security Rules ‡πÑ‡∏î‡πâ
- üì¥ **Offline**: Check role ‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï

### ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î:
- üì¶ **‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î**: 1000 bytes
- üîÑ **‡∏ï‡πâ‡∏≠‡∏á refresh**: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô role ‡∏ï‡πâ‡∏≠‡∏á refresh token
- üìä **Sync**: ‡∏ï‡πâ‡∏≠‡∏á sync ‡∏Å‡∏±‡∏ö Firestore ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

---

## üöÄ ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ

### 1. **Auto-Set Custom Claims**
‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á user ‡πÉ‡∏´‡∏°‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞:
```
1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Firebase Auth
2. ‚úÖ Set Custom Claims (role, username) ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Firestore document
```

### 2. **Auto-Update Custom Claims**
‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç role ‡∏Ç‡∏≠‡∏á user:
```
1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Firestore
2. ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Custom Claims ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
```

### 3. **Verification & Diagnosis**
‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Firestore role ‡πÅ‡∏•‡∏∞ Custom Claims role ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

### 4. **Batch Sync**
Sync role ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å users ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô

### 5. **Force Token Refresh**
‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ user re-login ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö claims ‡πÉ‡∏´‡∏°‡πà

---

## üìç ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤ Custom Claims Management

**‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Super Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!**

1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà **Admin Dashboard** (`/admin`)
2. ‡∏Ñ‡∏•‡∏¥‡∏Å **"Custom Claims"**
3. ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà `/admin/custom-claims` ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á

---

## üõ†Ô∏è ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

### ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô

#### 1. **‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á**

```
1. ‡πÄ‡∏Ç‡πâ‡∏≤ /admin/custom-claims
2. ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"
3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á:
   - ‚úÖ Users ‡∏ó‡∏µ‡πà sync ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
   - ‚ö†Ô∏è Users ‡∏ó‡∏µ‡πà role ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
```

#### 2. **Sync ‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô**

‡∏´‡∏≤‡∏Å‡∏û‡∏ö user ‡∏ó‡∏µ‡πà role ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô:
```
1. ‡∏î‡∏π‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á "Roles ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô"
2. ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "Sync" ‡∏ï‡∏£‡∏á user ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ sync role ‡∏à‡∏≤‡∏Å Firestore ‚Üí Custom Claims
```

#### 3. **Sync ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Batch)**

```
1. ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "Sync ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
2. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ sync role ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å users
```

---

## üîß ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á (Troubleshooting)

### 1. **‡∏î‡∏π Custom Claims**

‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ user ‡∏°‡∏µ claims ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á:
```
1. ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏π" (Eye icon)
2. ‡πÄ‡∏´‡πá‡∏ô JSON ‡∏Ç‡∏≠‡∏á custom claims:
   {
     "role": "user",
     "username": "teacher01",
     "updatedAt": "2024-12-16T..."
   }
```

### 2. **Force Token Refresh**

‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ user re-login ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö claims ‡πÉ‡∏´‡∏°‡πà:
```
1. ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "Refresh" (Zap icon)
2. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
3. User ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å sign out ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
4. ‡∏ï‡πâ‡∏≠‡∏á login ‡πÉ‡∏´‡∏°‡πà ‚Üí ‡∏à‡∏∞‡πÑ‡∏î‡πâ claims ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß
```

**‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠:**
- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô role ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà user ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ role ‡πÄ‡∏Å‡πà‡∏≤
- Custom claims ‡πÑ‡∏°‡πà refresh ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

### 3. **‡∏•‡∏ö Custom Claims**

‡∏•‡∏ö claims ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å user (reset to default):
```
1. ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡∏•‡∏ö" (Trash icon)
2. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
3. User ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ custom claims
```

**‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á:** User ‡∏≠‡∏≤‡∏à‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞ set claims ‡πÉ‡∏´‡∏°‡πà

---

## üìä ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö

### Flow: ‡∏™‡∏£‡πâ‡∏≤‡∏á User ‡πÉ‡∏´‡∏°‡πà

```
Admin ‡∏™‡∏£‡πâ‡∏≤‡∏á user ‚Üí createUser()
  ‚Üì
1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Firebase Auth (UID: abc123)
  ‚Üì
2. ‚úÖ Set Custom Claims
   await adminAuth.setCustomUserClaims('abc123', {
     role: 'user',
     username: 'teacher01'
   })
  ‚Üì
3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Firestore document
  ‚Üì
‚úÖ User ‡∏°‡∏µ role ‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ô Auth ‡πÅ‡∏•‡∏∞ Firestore
```

### Flow: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Role

```
Admin ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç role ‚Üí updateUser()
  ‚Üì
1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Firestore (role: 'user' ‚Üí 'director')
  ‚Üì
2. ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Custom Claims ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
   await adminAuth.setCustomUserClaims(uid, {
     role: 'director',
     updatedAt: '2024-12-16T...'
   })
  ‚Üì
‚úÖ Role sync ‡πÅ‡∏•‡πâ‡∏ß!
```

### Flow: User Login

```
User login ‚Üí AuthContext
  ‚Üì
1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Auth ‚úÖ
  ‚Üì
2. ‡∏î‡∏∂‡∏á user token
   const token = await user.getIdTokenResult()
   const role = token.claims.role // 'director'
  ‚Üì
3. (Optional) Query Firestore ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
  ‚Üì
‚úÖ Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏û‡∏£‡πâ‡∏≠‡∏° role ‡∏à‡∏≤‡∏Å Claims!
```

---

## üîç ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 1: Role ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà user ‡∏¢‡∏±‡∏á‡πÄ‡∏´‡πá‡∏ô role ‡πÄ‡∏Å‡πà‡∏≤

**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:** Token ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà refresh

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
1. **‡πÉ‡∏´‡πâ user logout + login ‡πÉ‡∏´‡∏°‡πà** (‡∏ß‡∏¥‡∏ò‡∏µ‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏î)
2. **‡πÉ‡∏ä‡πâ Force Token Refresh** (admin ‡∏ó‡∏≥‡πÉ‡∏´‡πâ):
   - ‡πÑ‡∏õ `/admin/custom-claims`
   - ‡∏Ñ‡∏•‡∏¥‡∏Å "Refresh" ‡∏ï‡∏£‡∏á user ‡∏ô‡∏±‡πâ‡∏ô
   - User ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å sign out ‚Üí ‡∏ï‡πâ‡∏≠‡∏á login ‡πÉ‡∏´‡∏°‡πà

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 2: Custom Claims ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ (role = null)

**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:** Claims ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å set

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
1. ‡πÑ‡∏õ `/admin/custom-claims`
2. ‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"
3. ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô user ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á "Roles ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô"
4. ‡∏Ñ‡∏•‡∏¥‡∏Å "Sync" ‡πÄ‡∏û‡∏∑‡πà‡∏≠ set claims ‡πÉ‡∏´‡∏°‡πà

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 3: Firestore role ‡∏Å‡∏±‡∏ö Custom Claims role ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô

**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:** ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç role ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÉ‡∏ô Firestore ‡∏´‡∏£‡∏∑‡∏≠ Firebase Console

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
1. ‡πÑ‡∏õ `/admin/custom-claims`
2. ‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"
3. ‡∏Ñ‡∏•‡∏¥‡∏Å "Sync ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏∏‡∏Å users ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 4: User ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏°‡∏µ Custom Claims System

**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:** User ‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ claims

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
1. ‡πÑ‡∏õ `/admin/custom-claims`
2. ‡∏Ñ‡∏•‡∏¥‡∏Å "Sync ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ set claims ‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å users

---

## üí° Best Practices

### ‚úÖ DO:

1. **‡∏™‡∏£‡πâ‡∏≤‡∏á user ‡∏ú‡πà‡∏≤‡∏ô Admin Panel ‡πÄ‡∏™‡∏°‡∏≠**
   - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ set claims ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

2. **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç role ‡∏ú‡πà‡∏≤‡∏ô Admin Panel**
   - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ sync claims ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

3. **‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö claims ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞**
   - ‡∏£‡∏±‡∏ô verification ‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
   - ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤

4. **‡πÉ‡∏ä‡πâ Batch Sync ‡πÄ‡∏°‡∏∑‡πà‡∏≠:**
   - ‡∏°‡∏µ‡∏Å‡∏≤‡∏£ migrate ‡∏£‡∏∞‡∏ö‡∏ö
   - ‡∏û‡∏ö users ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà sync

### ‚ùå DON'T:

1. **‡∏≠‡∏¢‡πà‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç role ‡∏ú‡πà‡∏≤‡∏ô Firebase Console**
   - ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ Firestore ‡∏Å‡∏±‡∏ö Claims ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
   - ‡πÉ‡∏ä‡πâ Admin Panel ‡πÅ‡∏ó‡∏ô

2. **‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏ö Claims ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô**
   - User ‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
   - ‡πÉ‡∏ä‡πâ Sync ‡πÅ‡∏ó‡∏ô

3. **‡∏≠‡∏¢‡πà‡∏≤ Force Refresh ‡∏ö‡πà‡∏≠‡∏¢‡πÜ**
   - User ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å sign out
   - ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô

---

## üîê Security Rules (Advanced)

‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Custom Claims ‡πÉ‡∏ô Firestore Security Rules:

```javascript
// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö role ‡∏à‡∏≤‡∏Å custom claims
    function isAdmin() {
      return request.auth.token.role in ['superadmin', 'director', 'deputy'];
    }
    
    function isSuperAdmin() {
      return request.auth.token.role == 'superadmin';
    }
    
    // ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô rules
    match /artifacts/{appId}/public/data/users/{userId} {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin();
    }
    
    match /artifacts/{appId}/public/data/entries/{entryId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if isAdmin() || 
        request.auth.token.username == resource.data.userId;
    }
  }
}
```

---

## üìà Monitoring & Maintenance

### ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå:
- ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö mismatches (‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô 0)

### ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:
- ‚úÖ ‡∏£‡∏±‡∏ô batch verification
- ‚úÖ Sync ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ mismatches)

### ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤:
- ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ Console Logs
- ‚úÖ ‡πÉ‡∏ä‡πâ "‡∏î‡∏π Claims" ‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug
- ‚úÖ Force refresh ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô

---

## üìö API Reference

### Server Actions

#### `setCustomClaims(params)`
‡∏ï‡∏±‡πâ‡∏á custom claims ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö user
```typescript
await setCustomClaims({
  uid: 'abc123',
  username: 'teacher01',
  role: 'director',
  currentUserRole: 'superadmin'
});
```

#### `syncRoleToCustomClaims(params)`
Sync role ‡∏à‡∏≤‡∏Å Firestore ‚Üí Custom Claims
```typescript
await syncRoleToCustomClaims({
  username: 'teacher01',
  currentUserRole: 'superadmin'
});
```

#### `verifyAllUserRoles(params)`
‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö roles ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å users
```typescript
const result = await verifyAllUserRoles({
  currentUserRole: 'superadmin'
});
// result.mismatches = [...users with mismatches]
```

#### `batchSyncAllRoles(params)`
Sync roles ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å users ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
```typescript
await batchSyncAllRoles({
  currentUserRole: 'superadmin',
  currentUsername: 'admin'
});
```

#### `forceTokenRefresh(params)`
‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö revoke refresh tokens
```typescript
await forceTokenRefresh({
  uid: 'abc123',
  username: 'teacher01',
  currentUserRole: 'superadmin'
});
```

---

## üéì ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 1: Setup ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å

```
‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå: ‡∏°‡∏µ users ‡πÄ‡∏Å‡πà‡∏≤ 50 ‡∏Ñ‡∏ô ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ custom claims

‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:
1. ‡πÑ‡∏õ /admin/custom-claims
2. ‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"
   ‚Üí ‡πÄ‡∏´‡πá‡∏ô 50 mismatches
3. ‡∏Ñ‡∏•‡∏¥‡∏Å "Sync ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
   ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö set claims ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡πâ‡∏á 50 ‡∏Ñ‡∏ô
4. ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‚úÖ
```

### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 2: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Role ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏£‡∏π

```
‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå: ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏π "teacher01" ‡πÄ‡∏õ‡πá‡∏ô ‡∏£‡∏≠‡∏á ‡∏ú‡∏≠.

‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:
1. ‡πÑ‡∏õ /admin/users
2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç "teacher01" ‚Üí role: deputy
3. ‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö update Custom Claims ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥!
4. (Optional) ‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ teacher01 logout + login ‡πÉ‡∏´‡∏°‡πà
   ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ token refresh
```

### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 3: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Role ‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï

```
‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô role ‡∏Ç‡∏≠‡∏á user ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà user ‡∏¢‡∏±‡∏á‡πÄ‡∏´‡πá‡∏ô role ‡πÄ‡∏Å‡πà‡∏≤

‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:
1. ‡πÑ‡∏õ /admin/custom-claims
2. ‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"
3. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö mismatch:
   ‚Üí ‡∏Ñ‡∏•‡∏¥‡∏Å "Refresh" ‡∏ï‡∏£‡∏á user ‡∏ô‡∏±‡πâ‡∏ô
   ‚Üí User ‡∏ï‡πâ‡∏≠‡∏á login ‡πÉ‡∏´‡∏°‡πà
4. ‡∏ñ‡πâ‡∏≤‡∏û‡∏ö mismatch:
   ‚Üí ‡∏Ñ‡∏•‡∏¥‡∏Å "Sync"
   ‚Üí User login ‡πÉ‡∏´‡∏°‡πà
```

---

## üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á

- **Custom Claims Management**: `/admin/custom-claims`
- **‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ**: `/admin/users`
- **Sync Users**: `/admin/sync-users`
- **Admin Dashboard**: `/admin`

---

## üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠

‡∏´‡∏≤‡∏Å‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:

1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console Logs
2. ‡∏î‡∏π Custom Claims ‡∏Ç‡∏≠‡∏á user ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
3. ‡∏•‡∏≠‡∏á Batch Sync ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
4. ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö

---

**Last Updated:** 2024-12-16  
**Version:** 1.0.0  
**System:** Hongson T-Folio - Custom Claims Management

